---
title: VPC
description: VPC
keywords:
  - VPC
sidebar_position: 4
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

## Configuration 

### 4 Configurations that are supported by the Amazon VPC console wizard 

- **VPC with a single public subnet**
  - We recommend this configuration if you need to run a single-tier, public-facing web application, such as a blog or a simple website.
- **VPC with public and private subnets (with NAT)**
  - We recommend this scenario if you want to run a public-facing web application while maintaining back-end servers that aren't publicly accessible.
- **VPC with public and private subnets and AWS Site-to-Site VPN access**
  - Plain english - can't access to the internet but allow access via Site-to-Site VPN access
  - We recommend this scenario if you want to extend your network into the cloud and also directly access the Internet from your VPC.
- **VPC with a private subnet only and AWS Site-to-Site VPN access**
  - We recommend this scenario if you want to extend your network into the cloud using Amazon's infrastructure without exposing your network to the Internet.


## Endpoints

Endpoints are virtual devices. They are horizontally scaled, redundant, and highly available VPC components. They allow communication between instances in your VPC and services without imposing availability risks or bandwidth constraints on your network traffic.

A VPC endpoint enables you to privately connect your VPC to supported AWS services and VPC endpoint services powered by AWS PrivateLink without requiring an internet gateway, NAT device, VPN connection, or AWS Direct Connect connection. Instances in your VPC do not require public IP addresses to communicate with resources in the service. Traffic between your VPC and the other service does not leave the Amazon network. There are two types of VPC endpoints: 
- interface endpoints
- gateway endpoints

An interface endpoint is an elastic network interface with a private IP address from the IP address range of your subnet that serves as an entry point for traffic destined to a supported service.

A gateway endpoint is a gateway that you specify as a target for a route in your route table for traffic destined to a supported AWS services (Almost all of them)

## Transit Gateway

AWS Transit Gateway is a service that enables customers to connect their **Amazon VPCs** and their **on-premises networks** to a single gateway. With AWS Transit Gateway, you only have to create and manage a single connection from the central gateway into each Amazon VPC, on-premises data center, or remote office across your network.

<Tabs className="Transit Gateway">
<TabItem value="before" label="Without AWS Transit Gateway">

![before](/img/aws/networking/tgw-before.png)
Complexity increases with scale. You must maintain routing tables within each VPC and connect to each onsite location using separate network gateways.

</TabItem>
<TabItem value="after" label="With AWS Transit Gateway">

![after](/img/aws/networking/tgw-after.png)
Your network is streamlined and scalable. AWS Transit Gateway routes all traffic to and from each VPC or VPN, and you have one place to manage and monitor it all.

</TabItem>
</Tabs>

## Bastion hosts

Including **bastion hosts** in your VPC environment enables you to securely connect to your Linux instances without exposing your environment to the Internet. After you set up your bastion hosts, you can access the other instances in your VPC through **Secure Shell (SSH)** connections on Linux. Bastion hosts are also configured with security groups to provide fine-grained ingress control.

You need to remember that **Bastion Hosts are using the SSH protocol**, which is a TCP based protocol on port 22. They must be publicly accessible.

## VPC Direct Connect Resiliency

### Maximum Resiliency for Critical Workloads

Maximum resilience is achieved by separate connections terminating on separate devices in more than one location. This configuration offers customers maximum resilience to failure. As shown in the figure below, such a topology provides resilience to 
- device failure
- connectivity failure
- complete location failure 

You can use [AWS Direct Connect gateway](https://docs.aws.amazon.com/directconnect/latest/UserGuide/direct-connect-gateways.html) to access any AWS Region (except AWS Regions in China) from any AWS Direct Connect locations.

![Redundancy-Highest](/img/aws/networking/vpc/Redundancy-Highest.png)

Source: [AWS Direct Connect Resiliency Recommendations](https://aws.amazon.com/directconnect/resiliency-recommendation/)


### High Resiliency for Critical Workloads

For critical production workloads that require high resiliency, it is recommended to have one connection at multiple locations. As shown in the figure below, such a topology ensures resilience to 
- connectivity failure due to a fiber cut or a device failure 
- a complete location failure 

You can use [AWS Direct Connect gateway](https://docs.aws.amazon.com/directconnect/latest/UserGuide/direct-connect-gateways.html) to access any AWS Region (except AWS Regions in China) from any AWS Direct Connect location.

![Redundancy-Higher](/img/aws/networking/vpc/Redundancy-Higher.png)

Source: [AWS Direct Connect Resiliency Recommendations](https://aws.amazon.com/directconnect/resiliency-recommendation/)


### Non-Critical Production Workloads or Development Workloads

As shown in the figure below, such a topology helps in the case of *the device failure at a location* but does not help in the event of *a total location failure*.

![non-critical-direct-connect](/img/aws/networking/vpc/non-critical-direct-connect.png)

Source: [AWS Direct Connect Resiliency Recommendations](https://aws.amazon.com/directconnect/resiliency-recommendation/)





## Internet Gateway

An Internet Gateway is a horizontally scaled, redundant, and highly available VPC component that allows communication between your VPC and the internet.

An Internet Gateway serves **two purposes**: 

-   to provide a target in your VPC route tables for internet-routable traffic 
-   to perform network address translation (NAT) for instances that have been assigned public IPv4 addresses.

To enable access to or from the internet for instances in a subnet in a VPC, you must do the following:

1.  Attach an Internet gateway to your VPC.
2.  Add a route to your subnet's route table that directs internet-bound traffic to the internet gateway. 
    - If a subnet is associated with a route table that has a route to an internet gateway, it's known as **a public subnet**. 
    - If a subnet is associated with a route table that does not have a route to an internet gateway, it's known as **a private subnet**.
3.  Ensure that instances in your subnet have a globally unique IP address (public IPv4 address, Elastic IP address, or IPv6 address).
4.  Ensure that your network access control lists and security group rules allow the relevant traffic to flow to and from your instance.


## NAT 

The following diagram illustrates the architecture of a VPC with a NAT gateway. The main route table sends internet traffic from the instances in the private subnet to the NAT gateway. The NAT gateway sends the traffic to the internet gateway using the NAT gateway’s Elastic IP address as the source IP address.

![nat-gateway-diagram](/img/aws/networking/vpc/nat-gateway-diagram.png)

Source: [AWS NAT Gateways](https://easycloudsupport.zendesk.com/hc/en-us/articles/360001916952-AWS-NAT-Gateways)

### NAT instance vs NAT gateway

These are the most 3 important points.
- **NAT instance** can be used as a bastion server
- Security Groups can be associated with a **NAT instances**
- **NAT instance** supports port forwarding

The following is a high-level summary of the differences between NAT gateways and NAT instances. We recommend that you use NAT gateways because they provide better availability and bandwidth and require less effort on your part to administer.

| Attribute            | NAT gateway                                                                                                                                                                                 | NAT instance                                                                                                                                                                      |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Maintenance          | Managed by AWS. You do not need to perform any maintenance.                                                                                                                                 | Managed by you, for example, by installing software updates or operating system patches on the instance.                                                                          |
| Cost                 | Charged depending on the number of NAT gateways you use, duration of usage, and amount of data that you send through the NAT gateways.                                                      | Charged depending on the number of NAT instances that you use, duration of usage, and instance type and size.                                                                     |
| Public IP addresses  | Choose the Elastic IP address to associate with a public NAT gateway at creation.                                                                                                           | Use an Elastic IP address or a public IP address with a NAT instance. You can change the public IP address at any time by associating a new Elastic IP address with the instance. |
| Private IP addresses | Automatically selected from the subnet's IP address range when you create the gateway.                                                                                                      | Assign a specific private IP address from the subnet's IP address range when you launch the instance.                                                                             |
| Security groups      | You cannot associate security groups with NAT gateways. You can associate them with the resources behind the NAT gateway to control inbound and outbound traffic.                           | Associate with your NAT instance and the resources behind your NAT instance to control inbound and outbound traffic.                                                              |
| Network ACLs         | Use a network ACL to control the traffic to and from the subnet in which your NAT gateway resides.                                                                                          | Use a network ACL to control the traffic to and from the subnet in which your NAT instance resides.                                                                               |
| Port forwarding      | Not supported.                                                                                                                                                                              | Manually customize the configuration to support port forwarding.                                                                                                                  |
| Bastion servers      | Not supported.                                                                                                                                                                              | Use as a bastion server.                                                                                                                                                          |

> Full table of comparision: [Compare NAT gateways and NAT instances](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-comparison.html)


### NAT in multiple AZ

If you have resources in multiple Availability Zones and they share one NAT gateway, and if the NAT gateway’s Availability Zone is down, **resources in the other Availability Zones lose internet access.** 

To incrase the availability of the system, you need to create an Availability Zone-independent architecture - which means you need to create a NAT gateway in each Availability Zone and configure your routing to **ensure that resources use the NAT gateway in the same Availability Zone.**

> [NAT gateway basics](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html)

## VPN

### Site-to-Site VPN

Amazon VPC provides the facility to create an **IPsec VPN** connection (also known as **site-to-site VPN**) between *remote customer networks and their Amazon VPC over the internet*. The following are the key concepts for a site-to-site VPN:

- Virtual private gateway: A Virtual Private Gateway (also known as a VPN Gateway) is the endpoint on the AWS VPC side of your VPN connection.
- VPN connection: A secure connection between your on-premises equipment and your VPCs.
- VPN tunnel: An encrypted link where data can pass from the customer network to or from AWS.
- Customer Gateway: An AWS resource that provides information to AWS about your Customer Gateway device.
- Customer Gateway device: A physical device or software application on the customer side of the Site-to-Site VPN connection.


### When to use VPN CloudHub

![AWS_VPN_CloudHub-diagram](/img/aws/networking/vpc/AWS_VPN_CloudHub-diagram.png)

Source: [VPN CloudHub](https://docs.aws.amazon.com/vpn/latest/s2svpn/VPN_CloudHub.html)

There are 2 use cases that you may consider to use VPN CloudHub:

- If you have multiple AWS Site-to-Site VPN connections, you can provide secure communication between sites using the AWS VPN CloudHub.   This enables your remote sites to communicate with each other, and not just with the VPC. 
- Sites that use AWS Direct Connect connections to the virtual private gateway can also be part of the AWS VPN CloudHub.

## Elastic IP

> EIPs are used any time you need a static + public IP. More infor about static and public ip, please check [Static & Public IP Address](/linux/network/ip-dns-cidr/#static--public-ip-address)

Within the AWS infrastructure, customers have virtual private clouds (VPC), within the VPCs, users have instances. So when you launch an EC2 instance, you receive a **Public IP address** by which that instance is reachable from internet. Once you stop that instance and restart the instance you get a new Public IP for the same instance. So it's basically a problem to connect your instance from internet for not having a static IP. To overcome this problem, we attach an Elastic IP to an Instance which doesn't change after you stop / start the instance.

In general, you should be good without Elastic IPs for most of the use-cases. If you're using [AWS Load Balancers](https://aws.amazon.com/elasticloadbalancing/?tag=hotoge-20), you won't want to use Elastic IPs, as your gateway address (the last endpoint before going out to the internet) is be the Load Balancer itself, which has a static hostname (but not a static IP). The load balancer runs on AWS, and you associate it with instances based on their instance IDs, not the public IP address. But, if you're using an external CDN service like [Fastly](https://www.fastly.com/), you need to use Elastic IPs, as the gateway IP is the EC2 instance's public IP.

By default, all AWS accounts are limited to five (5) Elastic IP addresses per Region, because public (IPv4) internet addresses are a scarce public resource. 

### Use case

Let’s say you setup the apache to host a website. Now, you need to scale up that machine due to any reason or you need to move that machine into another reason , you need to stop that machine. Whenever you restart again, the public ip from associated with that machine can also change. 

So it may be the case that you need to update all DNS entries again. However, You can reserve the public ip for you and that ip can be attached to any ec2 which you have, so there will be no issue regarding PUBLIC IP Change.

:::caution Cost
Elastic IP is a free service, but you’re limited to five in total (to prevent exhaustion of Amazon’s address pool). And, while they are entirely free to use, they’re actually **the only AWS service that costs money if you don’t use it** — having an Elastic IP provisioned but not attached to a running machine will cost you $7.50 a month. Make sure your machine isn’t off for extended periods of time, and if you change servers or stop using the IP, make sure to release it so you aren’t charged for letting it sit idle in your account.


:::

## Troubleshooting

### Share subnet across accounts

AWS Resource Access Manager (RAM) is a service that enables you to easily and securely share AWS resources with any AWS account or within your AWS Organization. 
The correct solution is to share the subnet(s) within a VPC using RAM. This will allow all EC2 instances to be deployed in the same VPC (although from different accounts) and easily communicate with one another.

To set this up, the account that owns the VPC (owner) shares one or more subnets with other accounts (participants) that belong to the same organization from AWS Organizations. 
After a subnet is shared, the participants can view, create, modify, and delete their application resources in the subnets shared with them. Participants cannot view, modify, or delete resources that belong to other participants or the VPC owner.
