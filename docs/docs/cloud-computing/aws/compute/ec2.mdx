---
title: EC2
description: EC2
keywords:
  - EC2
sidebar_position: 1
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

## Types of EC2

### Spot Instance

You can use Spot Instances to purchase extra computing power at a discounted price to supplement On-Demand Instances. They are a more affordable option than On-Demand EC2 pricing. Flexible and fault-tolerant applications and high-performance workloads use them. Spot Instances are also ideal for flexible workloads, such as data analysis, batch jobs, background processing, and optional tasks. For more information, see [Amazon EC2 Spot Instances](https://aws.amazon.com/ec2/spot-instances/).

AWS Spot Instances help reduce On-Demand Instance costs on EC2. You can use Spot Instances **to supplement On-Demand Instances**. Spot Instances shouldn’t handle all workloads because of potential service disruptions.

:::info Spot Instance interruption
Amazon EC2 terminates, stops, or hibernates your Spot Instance when Amazon EC2 needs the capacity back. Amazon EC2 provides a Spot Instance interruption notice, which gives the instance a two-minute warning before it is interrupted.
:::

:::info Spot Instance request
If your **Spot Instance request** is active and has an associated running **Spot Instance**, or your **Spot Instance request** is disabled and has an associated stopped **Spot Instance**, canceling the request *does not terminate the instance; you must terminate the running Spot Instance manually*. 

Moreover, to cancel a persistent Spot request and terminate its Spot Instances, you must cancel the **Spot request** first and then terminate the **Spot Instances**. 
:::

#### Spot Instance Interruption behaviors 

You can specify that Amazon EC2 should do one of the following when it interrupts a Spot Instance:

- Stop the Spot Instance
- Hibernate the Spot Instance
- Terminate the Spot Instance (default behavoir)
#### Spot Fleet

The Spot Fleet selects the Spot Instance pools that meet your needs and launches Spot Instances to meet the target capacity for the fleet. By default, Spot Fleets are set to maintain target capacity by launching replacement instances after Spot Instances in the fleet are terminated.


### Reserved EC2 Instance

Reserved Instances provide you with significant savings on your Amazon EC2 costs compared to On-Demand Instance pricing. Reserved Instances are not physical instances, but rather **a billing discount** applied to the use of On-Demand Instances in your account. 

When you purchase a Reserved Instance, you determine the scope of the Reserved Instance. The scope is either regional or zonal.

- **Regional**: When you purchase a Reserved Instance for a Region, it's referred to as a regional Reserved Instance. **It does not reserve capacity.**
- **Zonal**: When you purchase a Reserved Instance for a specific Availability Zone, it's referred to as a zonal Reserved Instance. **It reserves capacity.**

By creating Capacity Reservations, you ensure that you always have access to EC2 capacity when you need it, for as long as you need it. You can also sepecify the duratin for how long you want it to be

[AWS official link: On-Demand Capacity Reservations](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-capacity-reservations.html)

## Placement Groups

**A Spread placement group** is a group of instances that are each placed on distinct racks, with each rack having its own network and power source.

Spread placement groups are recommended for applications that have a small number of critical instances that should be kept separate from each other. Launching instances in a spread placement group reduces the risk of simultaneous failures that might occur when instances share the same racks.

A spread placement group can span multiple Availability Zones in the same Region. You can have **a maximum of 7 running instances per Availability Zone per group**. Therefore, to deploy 15 EC2 instances in a single Spread placement group, the company needs to use 3 AZs.

![placementgroups](/img/aws/compute/placementgroups.jpeg)
Source: [AWS - Placement Groups](https://tridentsys.net/aws-placement-groups/)

### Cluster
- Same rack and same availability zone
- Great network, low latency (10Gbps bandwidth between instances)
- Cons: if rack fails then all the EC2 instances will fail at the same time

Usage: Big data job that needs to complete fast, Application with low latency and high throughput.

### Spread
- All EC2 instance will be located on different hardware
- Span across multiple AZ
- Reduced risk of simultaneous failure
- Limit of **7 instances** per AZ per placement group

Usage: Application that needs maximize HA , Critical Applications that needs to be isolated from failure from each other

### Partition
- Up to 7 partitions per AZ with **100s** of EC2 instances
- The instances of 1 partition do not share racks with instances of other partitions
- A partition failure can affect many EC2 instances from same partition but it won't affect other EC2 instances on other partitions
- EC2 instances can get access to the partition information using metadata

Usage: This strategy is typically used by large distributed and replicated workloads, such as Hadoop, Cassandra, and Kafka. 

## EC2 life cycle
### Hibernate

When you EC2 Instance Hibernate to hibernate an instance, AWS signals the operating system to perform hibernation (suspend-to-disk). Hibernation saves the contents from the instance memory (RAM) to your Amazon EBS root volume. AWS then persists the instance's Amazon EBS root volume and any attached Amazon EBS data volumes.

When you start your instance:
- The Amazon EBS root volume is restored to its previous state
- The RAM contents are reloaded
- The processes that were previously running on the instance are resumed
- Previously attached data volumes are reattached and the instance retains its instance ID

Overview of EC2 hibernation: 
![hibernate](/img/aws/compute/hibernate.png)
Source: [Let’s talk about EC2 Placement Groups and Hibernate](https://enlear.academy/lets-talk-about-ec2-placement-groups-and-hibernate-a6e4bed854c?gi=90ed20ac88d9)


## Configuration

### Shutdown Behavior

By default, the Shutdown Behavior is set to "stop" for EC2 instances. When an instance is stopped, the instance is moved to a stopped state, and the instance's Amazon EBS (Elastic Block Store) volumes are preserved. This allows you to start the instance again later and retain the data and configuration.

However, you can also choose to set the Shutdown Behavior to "terminate" for an instance. In this case, when the instance is stopped, it is automatically terminated, and the instance and its associated resources, including EBS volumes, are deleted. The data and configuration stored on the instance and its volumes will be lost.

> This terminate behavior is not applicable when shutting down from AWS console. You have to run shutdown command from the EC2 instance to terminate the EC2 instance.

CLI Attribute: `InstanceInitiatedShutdownBehavior`


### Termination protection

This is a setting to protect against accidental termination in AWS Console or CLI

We have an instance where shutdown behavior = terminate and enable terminate protection is ticked
- We shutdown the instance from the OS, what will happen ?
- The instance will still be terminated!

### User data scripts

User Data is generally used to perform common automated configuration tasks and even run scripts after the instance starts.

When you launch an instance in Amazon EC2, you have the option of passing user data to the instance that can be used to perform common automated configuration tasks and even run scripts after the instance starts. You can pass two types of user data to Amazon EC2: 
- shell scripts 
- cloud-init directives.

:::caution Default behaviour
- By default, scripts entered as user data are executed with root user privileges
- By default, user data runs only during the boot cycle when you first launch an instance
:::


### Tenancy

Each EC2 instance that you launch into a VPC has a tenancy attribute. This attribute has the following values.

-   Shared (`default`) --- Multiple AWS accounts may share the same physical hardware.
-   Dedicated Instance (`dedicated`) --- Your instance runs on single-tenant hardware.
-   Dedicated Host (`host`) --- Your instance runs on a physical server with EC2 instance capacity fully dedicated to your use, an isolated server with configurations that you can control.


![ec2-tenancy](/img/aws/compute/ec2-tenancy.png)

Source: [New – T3 Instances on Dedicated Single-Tenant Hardware](https://aws.amazon.com/blogs/aws/new-t3-instances-on-dedicated-single-tenant-hardware/)

The more isolated of your EC2 instance, the more expensive it will be. Here is the price ordering: Dedicated Host > Dedicated instance > Shared(default)

:::caution Type change
You can only change the tenancy of an instance from dedicated to host, or from host to dedicated after you've launched it. 
:::

#### Dedicated host vs Dedicated instances
An important difference between a Dedicated Host and a Dedicated instance is that a Dedicated Host gives you additional visibility and control over how instances are placed on a physical server, and you can consistently deploy your instances to the same physical server over time. 

As a result, Dedicated Hosts enable you to use your existing server-bound software licenses and address corporate compliance and regulatory requirements.

**Dedicated instances**: If you stop/start instance, you can get some other hardware somewhere else. Basically, the hardware is "yours" (you are not sharing it with others) for the time your instance is running. You stop/start it, you may get different physical machine later on (maybe older, maybe newer, maybe its specs will be a bit different), and so on. *So your instance is moved around on different physical servers - whichever is not occupied by others at the time*.

**Dedicated host**:  With Dedicated Host the physical server is basically yours. It does not change, *it's always the same physical machine for as long as you are paying*.


## AMI

### No-Reboot Option

- By default, it’s not selected (AWS will shut down the instance before creating an AMI to maintain the **file system integrity**)
- Enabling this option allowing you to create an AMI without shutting down your instance. It is beneficial in situations where you want to create an AMI without disrupting the availability or continuity of your applications.

:::caution
**OS Buffers** are not flushed to disk before the snapshot is created when enabling the no-reboot option
:::

You can use AWS Backup to create a backup plan by configuring backup policies and monitoring activity for your AWS resources in one place. Rembmer *a backup plan* doesn't reboot the instances while taking EBS snapshots with AMI no-reboot behavior
- With this behavior, the AMI can't guarantee **file system integrity** since it doesn't reboot the EC2
- To maintain **file system integrity** you need to provide the reboot parameter while taking images (EventBridge + Lambda + CreateImage API with reboot parament)

![Product-Page-Diagram_AWS-Backup](/img/aws/compute/Product-Page-Diagram_AWS-Backup.png)

Source: [AWS backup](https://aws.amazon.com/backup/)
[What is AWS backup?](https://docs.aws.amazon.com/aws-backup/latest/devguide/whatisbackup.html)

### Copying AMIs across regions

- You can copy an AMI across AWS Regions
- You can share an AMI with another AWS account

  You can copy an AMI within or across AWS Regions using the AWS Management Console, the AWS Command Line Interface or SDKs, or the Amazon EC2 API, all of which support the CopyImage action. You can copy both Amazon EBS-backed AMIs and instance-store-backed AMIs. You can copy AMIs with encrypted snapshots and also change encryption status during the copy process. 

  ![copy-AMI](/img/aws/compute/copy-AMI.png)
  > Source: [AWS - Encryption and copying](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/CopyingAMIs.html)

- Copying an AMI backed by an encrypted snapshot cannot result in an unencrypted target snapshot.

  The following table shows encryption support for various AMI-copying scenarios. While it is possible to copy an unencrypted snapshot to yield an encrypted snapshot, you cannot copy an encrypted snapshot to yield an unencrypted one. 

  | Scenario | Description                | Supported |
  | -------- | -------------------------- | --------- |
  | 1        | Unencrypted-to-unencrypted | Yes       |
  | 2        | Encrypted-to-encrypted     | Yes       |
  | 3        | Unencrypted-to-encrypted   | Yes       |
  | 4        | Encrypted-to-unencrypted   | No        |
  > Source: [AWS - Encryption and copying](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/CopyingAMIs.html)

### Cross-accounts sharing AMIs 

- Sharing an AMI does not affect the ownership of the AMI
- If you're sharing the AMI with an encrypted volume that means that you need to share any key that is attached to that volume as well that was used to encrypt and decrypt that volume otherwise the targeted account cannot use your volume.

### Cross-accounts copying AMI

- If you copy an AMI that has been shared with your account, you are the owner of the target AMI in your account
- The owner of the source AMI must grant you read permissions for the storage that backs the AMI (EBS Snapshot)
- If the shared AMI has encrypted snapshots, the owner must share the key or keys with you as well

## Troubleshooting

### Availability

An application is currently hosted on four EC2 instances (behind Application Load Balancer) deployed in a single Availability Zone (AZ). To maintain an acceptable level of end-user experience, the application needs at least 4 instances to be always available. 

What is your recommandation to achieve high availability with MINIMUM cost?

<Tabs className="api-tabs">
<TabItem value="correct" label="Correct Answer">

Deploy the instances in three Availability Zones. Launch two instances in each Availability Zone.

</TabItem>
<TabItem value="incorrect" label="Incorrect Answer">

Deploy the instances in two Availability Zones. Launch two instances in each Availability Zone - When we launch two instances in two AZs, we run the risk of falling below the minimum acceptable threshold of 4 instances if one of the AZs fails. 

So this option is not correct.
</TabItem>
</Tabs>

### Cost

You have deployed a database technology that has a synchronous replication mode to survive disasters in data centers. The database is therefore deployed on two EC2 instances in two Availability Zones. The database must be publicly available so you have deployed the EC2 instances in public subnets. The replication protocol currently uses the EC2 public IP addresses.

What can you do to decrease the replication cost?

The answer is **to use the EC2 instances private IP for the replication** - The source of the cost is that traffic between two EC2 instances is going over the public internet, thus incurring high costs. Here, the correct answer is to use Private IP, so that the network remains private, for a minimal cost.


### How can EC2 securely connect to AWS services?

Use an IAM Instance Role

* instead of passing your own AWS account creditental in your codebase
* You can’t use SSM either, because you also need your credential too call the AWS SDK to get the SSM which - again you need to provide your account credential (A question of which came first: the chicken or the egg?)

Each Amazon EC2 instance contains metadata that the AWS CLI can directly query for temporary credentials. When an IAM role is attached to the instance, the AWS CLI automatically and securely retrieves the credentials from the instance metadata.

![ec2-role-instance](/img/aws/compute/roles-usingrole-ec2roleinstance.png)

Source: [Using an IAM role to grant permissions to applications running on Amazon EC2 instances](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2.html)


### Launch Issues

#### InstanceLimitExceeded

:::info
vCPU-based limits only apply to running **On-Demand instances** and **Spot instances**
:::

The InstanceLimitExceeded error in AWS occurs when you attempt to launch or create new EC2 instances but reach your account's limit for the maximum number of **vCPUs** per region. Each AWS account has certain service limits in place, including EC2 instance limits, to prevent abuse or overutilization of resources.

For t2 micros, we can see we have one vCPU, but if we choose an instance such as the C59 xlarge, we have 36 vCPU, so using this instance type, it would quickly reach the limit.

Resolution: Either launch the instance in a different region or request AWS to increase your limit of the region

#### InsufficientInstanceCapacity

If you get this error, it means AWS does not have that enough On-Demand capacity in the particular AZ where the instance is launched.

#### Instance Terminates Immediately

Instance Terminates Immediately means that the EC2 goes from pending to terminated

- You've reached your EBS volume limit.
- An EBS snapshot is corrupt.
- The root EBS volume is encrypted and you do not have permissions to access
the KMS key for decryption.
- The instance store-backed AMI that you used to launch the instance is missing a
required part (an image.part.xx file).

### SSH Issues

- Make sure the private key (pem file) on your linux machine has 400
permissions, else you will get “Unprotected private key file” error
- Make sure the username for the OS is given correctly when logging via SSH, else you will get “Host key not found”, “Permission denied”, or “Connection closed by [instance] port 22” error

- Possible reasons for “Connection timed out” to EC2 instance via SSH:
  - SG is not configured correctly
  - NACL is not configured correctly
  - Check the route table for the subnet (routes traffic destined outside VPC to IGW) 
  - Instance doesn’t have a public IPv4
  - CPU load of the instance is high