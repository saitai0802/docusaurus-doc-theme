---
title: ASG
description: ASG
keywords:
  - ASG
sidebar_position: 2
---

## Behaviour

### Difference of using CLI or console to create ASG launch configuration?

By default, **basic monitoring** is enabled when you use the AWS management console to create a launch configuration. 
**Detailed monitoring** is enabled by default when you create a launch configuration using the AWS CLI


### ASG terminates unhealthy EC2 instance

:::info Scaling Sequence
After ternminate instances, it then addes new instances.
:::

To maintain the same number of instances, Amazon EC2 Auto Scaling performs a periodic health check on running instances within an Auto Scaling group. When it finds that an instance is unhealthy, it terminates that instance and launches a new one. 

Amazon EC2 Auto Scaling creates a new scaling activity for terminating the unhealthy instance and then terminates it. Later, another scaling activity launches a new instance to replace the terminated instance.


### Rebalancing activities

:::info Scaling Sequence
After launching new instances, it then terminates old instances. [AWS - Official document](https://docs.aws.amazon.com/autoscaling/ec2/userguide/auto-scaling-benefits.html)
:::

Rebalancing activities fall into two categories: **Availability Zone rebalancing** and **capacity rebalancing**

#### Availability Zone rebalancing

After certain actions occur, your Auto Scaling group can become unbalanced between Availability Zones. Amazon EC2 Auto Scaling compensates by rebalancing the Availability Zones. The following actions can lead to rebalancing activity:

- You change the Availability Zones for your group.
- You explicitly terminate or detach instances and the group becomes unbalanced.
- An Availability Zone that previously had insufficient capacity recovers and has additional capacity available.
- An Availability Zone that previously had a Spot price above your maximum price now has a Spot price below your maximum price.

#### Capacity Rebalancing

You can enable Capacity Rebalancing for your Auto Scaling groups when using Spot Instances. When you turn on Capacity Rebalancing, Amazon EC2 Auto Scaling attempts to launch a Spot Instance whenever Amazon EC2 notifies that a Spot Instance is at an elevated risk of interruption. 


###  VPC Tenancy and ASG Tenancy

> Source: [Configure instance tenancy with a launch configuration](https://docs.aws.amazon.com/autoscaling/ec2/userguide/auto-scaling-dedicated-instances.html)

A launch configuration is an instance configuration template that an Auto Scaling group uses to launch EC2 instances. When you create a launch configuration, you specify information for the instances. Include the ID of the Amazon Machine Image (AMI), the instance type, a key pair, one or more security groups, and a block device mapping. If you've launched an EC2 instance before, you specified the same information to launch the instance.

When you create a launch configuration, the default value for the instance placement tenancy is `null` and the instance tenancy is controlled by the tenancy attribute of the VPC. If you set the **Launch Configuration Tenancy** to default and the **VPC Tenancy** is set to dedicated, then the instances have dedicated tenancy. If you set the **Launch Configuration Tenancy** to dedicated and the **VPC Tenancy** is set to default, then again the instances have dedicated tenancy.

**Launch Configuration Tenancy vs VPC Tenancy**

| Launch configuration tenancy | VPC tenancy = `default`  | VPC tenancy = `dedicated` |
| ---------------------------- | ------------------------ | ------------------------- |
| not specified                | shared-tenancy instances | Dedicated Instances       |
| `default`                    | shared-tenancy instances | Dedicated Instances       |
| `dedicated`                  | Dedicated Instances      | Dedicated Instances


![ec2-tenancy](/img/aws/compute/ec2-tenancy.png)

Source: [New â€“ T3 Instances on Dedicated Single-Tenant Hardware](https://aws.amazon.com/blogs/aws/new-t3-instances-on-dedicated-single-tenant-hardware/)

![vpc-tenancy](/img/aws/compute/vpc-tenancy.png)

Source: [How to Create AWS VPC in 10 steps, less than 10 min](https://varunmanik1.medium.com/how-to-create-aws-vpc-in-10-steps-less-than-5-min-a49ac12064aa)


## Configuration

### EC2 Auto Scaling works with both ALB and NLB

Amazon EC2 Auto Scaling works with Application Load Balancers and Network Load Balancers including their health check feature.

### Target Tracking Scaling Policy

- ASGAverageNetworkOut -  This represents the Average number of bytes sent out on all network interfaces by the Auto Scaling group. 
- ALBRequestCountPerTarget
- ASGAverageCPUUtilization


## Troubleshooting

### 2 policy being trickered at the same time

Imagine there is a scenario which - A retail company has a fleet of EC2 instances running behind an Auto Scaling group (ASG). The development team has configured two metrics that control the *scale-in and scale-out policies* of ASG. 

- First one is a target tracking policy that uses a custom metric to **add and remove two new instances**, based on the number of SQS messages in the queue. 
- The other is a step scaling policy that uses the CloudWatch CPUUtilization metric to launch **one new instance** when the existing instance exceeds 90 percent utilization for a specified length of time.

While testing, the *scale-out policy criteria* for both policies was met at the same time. How many new instances will be launched because of these multiple scaling policies? 

:::info Answer
Amazon EC2 Auto Scaling chooses the policy that provides the largest capacity, so policy with the custom metric is triggered, and two new instances will be launched by the ASG 
:::


### EC2 Auto Scaling cannot add a volume 

Amazon EC2 Auto Scaling cannot add a volume (Volumne = EBS volume) to an existing instance if the existing volume is approaching capacity

A volume is attached to a new instance when it is added. Amazon EC2 Auto Scaling doesn't automatically add a volume when the existing one is approaching capacity. You can use the EC2 API to add a volume to an existing instance.


### ALB removed an instance but ASG fail to provision

Let's say you're using an ALB that routes the requests to the underlying EC2 instances and you noticed a peculiar pattern. The **ALB** removes an instance whenever it is detected as unhealthy but the **ASG** fails to kick-in and provision the replacement instance. What is the reason?

If the **ASG** is using **EC2** as the health check type and the **ALB** is using its in-built health check, *there may be a situation where the ALB health check fails because the health check pings fail to receive a response from the instance*. **(Network issue)** At the same time, **ASG health check can come back as successful** because it is based on **EC2 based health check**. 

Therefore, in this scenario, the **ALB** will remove the instance from its inventory, however, the **ASG** will fail to provide the replacement instance. This can lead to the scaling issues mentioned in the problem statement.

## Cost-efficient 

### Don't use ALB for automatically recover

Imagine you are deploying a critical monolith application that must be deployed on a single web server, as it hasn't been created to work in distributed mode. Still, you want to make sure your setup can automatically recover from the failure of an AZ.

- Create an **auto-scaling group** that spans across 2 AZ, which min=1, max=1, desired=1
- Create an **Elastic IP** and use the EC2 user-data script to attach it
  - With an Elastic IP address, you can mask the failure of an instance or software by rapidly remapping the address to another instance in your account.
- Assign an EC2 Instance Role to perform the necessary API calls
  - For that Elastic IP to be attached to our EC2 instance, we must use an EC2 user data script, and our EC2 instance must have the correct IAM permissions to perform the API call, so we need an EC2 instance role.

:::caution Don't use ALB and a target group with the instance(s) of the Auto Scaling Group
If we use an ALB, things will still work, but we will have to **pay for the provisioned ALB** which sends traffic to only one EC2 instance. 
:::